{% extends "polls/base.html" %}
{% load humanize %}
{% load poll_extras %}

{% block content %}

{% if zl_unused|length > 0 %}
<div class="alert alert-danger">
  Assets with extra fills:
  <ul>
  {% for asset,qty in zl_unused %}
    <li>{{asset.symbol}}: {{qty}}</li>
  {% endfor %}
  </ul>
</div>
{% endif %}

{% if combined|length == 0 %}
  No orders are available.
{% else %}
  <div class="container">
    <em>
      <div class="row">
        <div class="col-xs-1">&nbsp;</div>
        <div class="col-xs-1">&nbsp;</div>
        <div class="col-xs-5 text-left"><b>Orders</b></div>
        <div class="col-xs-1">&nbsp;</div>
        <div class="col-xs-4 text-left"><b>Fills</b></div>
      </div>

      <div class="row">
        <div class="col-xs-1">&nbsp;</div>
        <div class="col-xs-1"><b>Symbol</b></div>

        <div class="col-xs-5">
          <div class="row">
            <div class="col-xs-1">&nbsp;</div>
            <div class="col-xs-1">&nbsp;</div>
            <div class="col-xs-1">Account</div>
            <div class="col-xs-2 text-right"><abbr title="Quantity">Q</abbr></div>
            <div class="col-xs-2 text-right"><abbr title="Filled">F</abbr></div>
            <div class="col-xs-2 text-right"><abbr title="Average Price">P</abbr></div>
            <div class="col-xs-3">Note</div>
          </div>
        </div>

        <div class="col-xs-1">Symbol</div>

        <div class="col-xs-4">
          <div class="row">
            <div class="col-xs-1">&nbsp;</div>
            <div class="col-xs-1">&nbsp;</div>
            <div class="col-xs-2 text-right"><abbr title="Quantity">Q</abbr></div>
            <div class="col-xs-2 text-right"><abbr title="Price">P</abbr></div>
            <div class="col-xs-6 text-nowrap">Note</div>
          </div>
        </div>

      </div>
    </em>

    {% for minute in combined %}
    <hr style="margin-top:5px;margin-bottom:5px">
    <div class="row">
        <div class="col-xs-1 text-right">
          <em>
            <div class="row"><b>{{minute.minute|strftime:"%H:%M"}}</b></div>
            <div class="row small text-muted">{{minute.minute|strftime:"%Y-%m-%d"}}</div>
          </em>
        </div>

        {% for duo in minute.duos %}
            <div class="col-xs-1">
              {% if duo.orders|length > 0 %}
              {{duo.asset.asset_symbol}}
              {% endif %}
            </div>

            <div class="col-xs-5">
              {% for order in duo.orders %}
              <div class="row {% if order.filled != order.amount %}text-warning{% endif %}">
                <div class="col-xs-1">
                  {% if order.filled != order.amount %}
                  <abbr title="Order is still open">
                    <span class="glyphicon glyphicon-alert"></span>
                  </abbr>
                  {% endif %}
                </div>

                <div class="col-xs-1">
                  <abbr title="Order">
                    <a href="{% url 'polls:detail' order.id %}">
                      #{{order.id}}
                    </a>
                  </abbr>
                </div>
                <div class="col-xs-1">{{order.account.account_symbol}}</div>
                <div class="col-xs-2 text-right">{{order.amount|intcomma}}</div>
                <div class="col-xs-2 text-right text-primary">{{order.filled|intcomma}}</div>
                <div class="col-xs-2 text-right text-primary">{{order.avgPrice|floatformat:"2"|intcomma}}</div>
                <div class="col-xs-3 text-muted">{{ order.order_text }}</div>
              </div>
              {% endfor %}
            </div>

            <div class="col-xs-1">
              {% if duo.fills|length > 0 %}
              {{duo.asset.asset_symbol}}
              {% endif %}
            </div>

            <div class="col-xs-4">
              {% for fill in duo.fills %}
              <div class="row {% if fill.has_unused %}text-danger{% endif %}">
                <div class="col-xs-1">
                  {% if fill.has_unused %}
                  <abbr title="Asset has unmatched fills">
                    <span class="glyphicon glyphicon-alert"></span>
                  </abbr>
                  {% endif %}
                </div>
                <div class="col-xs-1">#{{fill.id}}</div>
                <div class="col-xs-2 text-primary text-right">{{fill.fill_qty}}</div>
                <div class="col-xs-2 text-primary text-right">{{fill.fill_price}}</div>
                <div class="col-xs-6 text-muted">{{ fill.fill_text }}</div>
              </div>
              {% endfor %}
            </div>

        {% endfor %}
    </div>
    {% endfor %}

  </div>
{% endif %}

{% endblock %}
